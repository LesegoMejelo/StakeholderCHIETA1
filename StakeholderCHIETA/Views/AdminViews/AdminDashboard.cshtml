@{
    Layout = null;
}

<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Admin Dashboard — Users & Engagement</title>
    <link rel="stylesheet" href="~/Content/AdvisorView/AdminDashboard.css" />
    <style>
        /* Ensure modal displays when JS toggles .open */
        .modal[aria-hidden="true"] {
            display: none;
        }

        .modal.open {
            display: block;
        }
    </style>
</head>

<body>
    <!-- Top Bar -->
    <header class="topbar">
        <div class="container topbar-inner">
            <img class="logo" src="https://acfesa.co.za/sites/default/files/inline-images/CHIETA%20Logo.png" alt="CHIETA logo" />

            <nav class="header-actions">
                <div class="menu" id="settings">
                    <button class="icon-btn" id="settings-btn" aria-haspopup="menu" aria-expanded="false">
                        <span class="hide-sm">Settings</span>
                    </button>
                    <div class="menu-popover" id="settings-menu" role="menu" hidden>
                        <a role="menuitem" href="profile.html">Profile</a>
                        <a role="menuitem" href="notifications.html">Notifications</a>
                        <div class="menu-sep" role="separator"></div>
                        <a role="menuitem" href="logout.html" class="danger">Sign out</a>
                    </div>
                </div>
            </nav>
        </div>
    </header>

    <main class="container page">
        <!-- Decorative shapes -->
        <div class="decor blob-right"></div>
        <div class="decor arc-left"></div>
        <div class="decor arc-right-bottom"></div>

        <!-- Welcome / Hero -->
        <section class="hero container">
            <div class="hero__bg-blob" aria-hidden="true"></div>
            <div class="hero__content">
                <h1>Admin Dashboard — <span class="accent">Users & Engagement</span></h1>
                <p>Analyse users, appointments, and inquiries in one place.</p>
            </div>
        </section>

        <!-- KPI Cards -->
        <section class="kpis container">
            <article class="card kpi">
                <div class="kpi__label">Total Users</div>
                <div class="kpi__value" id="kpi-users">—</div>
                <div class="kpi__delta up" id="kpi-users-delta">+0 this week</div>
            </article>
            <article class="card kpi">
                <div class="kpi__label">Active Appointments</div>
                <div class="kpi__value" id="kpi-appointments">—</div>
                <div class="kpi__delta up" id="kpi-appointments-delta">+0 today</div>
            </article>
            <article class="card kpi">
                <div class="kpi__label">Open Inquiries</div>
                <div class="kpi__value" id="kpi-inquiries">—</div>
                <div class="kpi__delta down" id="kpi-inquiries-delta">0 resolved</div>
            </article>
            <article class="card kpi">
                <div class="kpi__label">User Growth Rate</div>
                <div class="kpi__value" id="kpi-growth">—</div>
                <div class="kpi__delta up" id="kpi-growth-delta">vs last month</div>
            </article>
        </section>

        <!-- Charts -->
        <section class="charts container">
            <article class="card chart-card">
                <header class="card__title-row">
                    <h2>User Engagement Analysis</h2>
                    <div class="chart-actions">
                        <select id="rangeSelect" class="select">
                            <option value="5" selected>Last 5 months</option>
                            <option value="12">Last 12 months</option>
                        </select>
                    </div>
                </header>
                <canvas id="lineChart" width="980" height="320" aria-label="Engagement chart"></canvas>
                <footer class="chart-legend">
                    <span class="dot dot--1"></span>Appointments
                    <span class="dot dot--2"></span>Inquiries
                </footer>
            </article>
        </section>

        <!-- User Management -->
        <section class="container">
            <article class="card">
                <header class="card__title-row">
                    <h2>User Management</h2>
                    <div class="row-actions">
                        <input id="userSearch" class="input" placeholder="Search users…" />
                        <button id="addUserBtn" type="button" class="cta small">+ Add New User</button>
                    </div>
                </header>
                <div class="table-wrap">
                    <table class="table" aria-label="Users table">
                        <thead>
                            <tr>
                                <th>Name</th>
                                <th>Email</th>
                                <th>Role</th>
                                <th>Status</th>
                                <th style="text-align:right;">Actions</th>
                            </tr>
                        </thead>
                        <tbody id="users-body">
                            <!-- Filled by JS -->
                        </tbody>
                    </table>
                </div>
                <div class="pagination" id="pager"></div>
            </article>
        </section>

        <!-- Footer -->
        <footer class="footer">
            <div class="container footer__inner">
                <button class="cta">Primary Action</button>
            </div>
        </footer>

        <!-- Modal for Add/Edit User -->
        <div class="modal" id="userModal" aria-hidden="true" role="dialog">
            <div class="modal__dialog">
                <header class="modal__header">
                    <h3 id="modalTitle">Add User</h3>
                    <button class="icon-btn dark" id="closeModal" aria-label="Close">✕</button>
                </header>
                <form id="userForm" class="form">
                    <input type="hidden" id="userId" />
                    <div class="form__row">
                        <label>Name</label>
                        <input id="Name" class="input" required />
                    </div>
                    <div class="form__row">
                        <label>Email</label>
                        <input id="email" type="email" class="input" required />
                    </div>
                    <div class="form__row">
                        <label>Password</label>
                        <input id="password" type="password" class="input" required />
                    </div>
                    <div class="form__row">
                        <label>Role</label>
                        <select id="Role" class="select">
                            <option value="Client">Client</option>
                            <option value="Advisor">Advisor</option>
                            <option value="Admin">Admin</option>
                        </select>
                    </div>
                    <div class="form__row">
                        <label>Status</label>
                        <select id="status" class="select">
                            <option value="Active">Active</option>
                            <option value="Suspended">Suspended</option>
                        </select>
                    </div>
                    <div class="form__actions">
                        <button type="button" class="btn ghost" id="cancelModal">Cancel</button>
                        <button type="submit" class="cta small">Save</button>
                    </div>
                </form>
            </div>
        </div>
    </main>

    <!-- Scripts -->
    <script>
        document.addEventListener("DOMContentLoaded", () => {
            const modal = document.getElementById("userModal");
            const addBtn = document.getElementById("addUserBtn");
            const closeBtn = document.getElementById("closeModal");
            const cancelBtn = document.getElementById("cancelModal");
            const userForm = document.getElementById("userForm");
            const usersBody = document.getElementById("users-body");

            function showModal() {
                modal.setAttribute("aria-hidden", "false");
                modal.classList.add("open");
            }
            function hideModal() {
                modal.setAttribute("aria-hidden", "true");
                modal.classList.remove("open");
            }

            addBtn.addEventListener("click", () => {
                userForm.reset();
                document.getElementById("userId").value = "";
                showModal();
            });
            closeBtn.addEventListener("click", hideModal);
            cancelBtn.addEventListener("click", hideModal);

            // Load Users
            async function loadUsers() {
                try {
                    const res = await fetch("/Auth/GetUsers");
                    if (!res.ok) throw new Error("Failed to load");
                    const users = await res.json();
                    usersBody.innerHTML = "";

                    users.forEach(u => {
                        const row = document.createElement("tr");
                        row.innerHTML = `
                            <td>${u.name}</td>
                            <td>${u.email}</td>
                            <td>${u.role}</td>
                            <td>${u.status}</td>
                            <td style="text-align:right;">
                                <button class="btn small danger" type="button">Delete</button>
                            </td>
                        `;
                        usersBody.appendChild(row);
                    });

                    document.getElementById("kpi-users").textContent = users.length;
                } catch (err) {
                    console.error("Failed to fetch users", err);
                }
            }

            // Save User
            userForm.addEventListener("submit", async (e) => {
                e.preventDefault();

                const user = {
                    Name: document.getElementById("Name").value,
                    Email: document.getElementById("email").value,
                    Password: document.getElementById("password").value,
                    Role: document.getElementById("Role").value,
                    Status: document.getElementById("status").value
                };

                try {
                    const res = await fetch("/Auth/RegisterUser", {
                        method: "POST",
                        headers: { "Content-Type": "application/json" },
                        body: JSON.stringify(user)
                    });
                    const data = await res.json();

                    if (res.ok) {
                        alert("✅ " + (data.message || "User saved"));
                        hideModal();
                        await loadUsers();
                    } else {
                        alert("❌ " + (data.message || "Error saving user"));
                    }
                } catch (err) {
                    console.error("Error saving user:", err);
                    alert("❌ Failed to save user");
                }
            });

            // Initial load
            loadUsers();
        });
    </script>
</body>
</html>
